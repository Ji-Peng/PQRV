#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "cpucycles.h"
#include "speed_print.h"

#define KYBER_N 256
#define KYBER_Q 3329
#define KYBER_ROOT_OF_UNITY 17

const int16_t zetas_ref[128] = {
    -1044, -758,  -359,  -1517, 1493,  1422,  287,   202,   -171,  622,
    1577,  182,   962,   -1202, -1474, 1468,  573,   -1325, 264,   383,
    -829,  1458,  -1602, -130,  -681,  1017,  732,   608,   -1542, 411,
    -205,  -1571, 1223,  652,   -552,  1015,  -1293, 1491,  -282,  -1544,
    516,   -8,    -320,  -666,  -1618, -1162, 126,   1469,  -853,  -90,
    -271,  830,   107,   -1421, -247,  -951,  -398,  961,   -1508, -725,
    448,   -1065, 677,   -1275, -1103, 430,   555,   843,   -1251, 871,
    1550,  105,   422,   587,   177,   -235,  -291,  -460,  1574,  1653,
    -246,  778,   1159,  -147,  -777,  1483,  -602,  1119,  -1590, 644,
    -872,  349,   418,   329,   -156,  -75,   817,   1097,  603,   610,
    1322,  -1285, -1465, 384,   -1215, -136,  1218,  -1335, -874,  220,
    -1187, -1659, -1185, -1530, -1278, 794,   -1510, -854,  -870,  478,
    -108,  -308,  996,   991,   958,   -1460, 1522,  1628};

const int32_t ntt_zetas_133merging[128 * 2] = {
    -950,  2064267850,  -1381, 966335387,   -720,  886345008,
    166,   -812805466,  -1242, -1370157786, -213,  1819136043,
    1467,  -249002309,  -255,  -1028263423, -856,  51606696,
    -18,   1847519726,  -1161, -1094061961, 1030,  700560902,
    -145,  89021551,    858,   -734105254,  -1252, 2042335004,
    1008,  -381889552,  1524,  -372858380,  -1572, -427045412,
    -302,  -21932846,   495,   732815087,   -174,  -752167598,
    -1236, 877313836,   -1564, 1137927652,  371,   98052723,
    -1038, 2029433330,  1076,  -2112004044, -507,  -932791035,
    -306,  1343064270,  237,   -1419184147, 691,   -1727534157,
    1647,  -1544330385, 1368,  1322421592,  -1140, -1817845876,
    -292,  860541660,   1636,  61928036,    -1006, -300609006,
    -372,  -1904287092, 1456,  1357256112,  700,   1643673276,
    865,   -975366559,  864,   1513366368,  1270,  405112566,
    -1310, 359956706,   -64,   365117376,   594,   -838608814,
    -1635, 1744306333,  491,   2097812203,  44,    -2130066388,
    -1569, 696690399,   334,   1986857806,  -799,  -72249375,
    1180,  1052776604,  -457,  -815385801,  -1088, 1912028096,
    -267,  -1228239371, -693,  -1884934581, 243,   828287475,
    1330,  1404992306,  1389,  598637677,   1372,  -42575524,
    -1211, -1211467195, 122,   1317260922,  1551,  1150829327,
    -1495, 1214047529,  -769,  -1719793153, 1616,  -1703020976,
    1033,  1824296713,  -293,  -945692709,  -589,  1279846067,
    -257,  -345764865,  -1596, -826997308,  -1442, -1839778722,
    -1640, 1303069080,  748,   -1851390228, -724,  -2043625172,
    -92,   1330162596,  -351,  1666896289,  -1001, 140628247,
    203,   1593356747,  -41,   -1041165097, -980,  -583155668,
    1367,  -483812777,  -47,   1006330577,  1449,  1598517417,
    -1416, -2122325384, 1462,  -690239562,  1478,  -1855260730,
    -1210, 594767174,   111,   -1371447953, -1163, -411563403,
    86,    717333078,   -1111, -976656727,  1087,  576704831,
    1535,  -1979116801, 802,   1195985186,  310,   1586905910,
    21,    -723783915,  840,   1113414472,  916,   948273044,
    -1388, 1207596692,  -613,  879894171,   -1255, 918599193,
    -1248, 677337888,   -600,  -1408862808, -697,  -519937465,
    -15,   -1323711759, 357,   580575333,   -265,  -1910737929,
    1217,  -836028479,  -1506, -1474661346, -596,  1521107372,
    -537,  714752743,   318,   -1143088322, 964,   1748176836,
    -1652, 1103093132,  -26,   282546662,   -434,  2073299022,
    -1361, -1563682897, -1176, 1877193576,  715,   -1327582261,
    -1073, -1059227441, -1040, -1583035408, -500,  -1174052340,
    -1452, 1572714068,  -442,  508325958,   -1035, -1141798155,
    1487,  1515946703,
};

const int32_t intt_zetas_133merging[128 * 2] = {
    -1487, -1515946703, 1035,  1141798155,  442,   -508325958,
    1452,  -1572714068, 500,   1174052340,  1040,  1583035408,
    1537,  1633351937,  -715,  1327582261,  1176,  -1877193576,
    1361,  1563682897,  434,   -2073299022, 26,    -282546662,
    1652,  -1103093132, -931,  2022982493,  -318,  1143088322,
    537,   -714752743,  596,   -1521107372, 1506,  1474661346,
    -1217, 836028479,   265,   1910737929,  1558,  909568022,
    15,    1323711759,  697,   519937465,   600,   1408862808,
    1248,  -677337888,  1255,  -918599193,  613,   -879894171,
    -621,  -685078893,  -916,  -948273044,  -840,  -1113414472,
    -21,   723783915,   -310,  -1586905910, -802,  -1195985186,
    -1535, 1979116801,  1592,  -2102972872, 1111,  976656727,
    -86,   -717333078,  1163,  411563403,   -111,  1371447953,
    1210,  -594767174,  -1478, 1855260730,  515,   -1797203197,
    1416,  2122325384,  -1449, -1598517417, 47,    -1006330577,
    -1367, 483812777,   980,   583155668,   41,    1041165097,
    429,   1780431021,  1001,  -140628247,  351,   -1666896289,
    92,    -1330162596, 724,   2043625172,  -748,  1851390228,
    1640,  -1303069080, 626,   1126316146,  1596,  826997308,
    257,   345764865,   589,   -1279846067, 293,   945692709,
    -1033, -1824296713, -1616, 1703020976,  -428,  25803348,
    1495,  -1214047529, -1551, -1150829327, -122,  -1317260922,
    1211,  1211467195,  -1372, 42575524,    -1389, -598637677,
    974,   -1664315954, -243,  -828287475,  693,   1884934581,
    267,   1228239371,  1088,  -1912028096, 457,   815385801,
    -1180, -1052776604, -475,  1032133925,  -334,  -1986857806,
    1569,  -696690399,  -44,   2130066388,  -491,  -2097812203,
    1635,  -1744306333, -594,  838608814,   -988,  2146838564,
    1310,  -359956706,  -1270, -405112566,  -864,  -1513366368,
    -865,  975366559,   -700,  -1643673276, -1456, -1357256112,
    83,    -406402733,  1006,  300609006,   -1636, -61928036,
    292,   -860541660,  1140,  1817845876,  -1368, -1322421592,
    -1647, 1544330385,  -360,  -1704311144, -237,  1419184147,
    306,   -1343064270, 507,   932791035,   -1076, 2112004044,
    1038,  -2029433330, -371,  -98052723,   -9,    923759863,
    1236,  -877313836,  174,   752167598,   -495,  -732815087,
    302,   21932846,    1572,  427045412,   -1524, 372858380,
    -1084, 547030980,   1252,  -2042335004, -858,  734105254,
    145,   -89021551,   -1030, -700560902,  1161,  1094061961,
    18,    -1847519726, 856,   -51606696,   255,   1028263423,
    -1467, 249002309,   213,   -1819136043, 1242,  1370157786,
    -166,  812805466,   720,   -886345008,  1381,  -966335387,
    950,   -2064267850,
};

const int32_t basemul_zetas_133merging[128 * 2] = {
    -302,  -21932846,   302,   21932846,    495,   732815087,
    -495,  -732815087,  -174,  -752167598,  174,   752167598,
    -1236, 877313836,   1236,  -877313836,  1076,  -2112004044,
    -1076, 2112004044,  -507,  -932791035,  507,   932791035,
    -306,  1343064270,  306,   -1343064270, 237,   -1419184147,
    -237,  1419184147,  -1140, -1817845876, 1140,  1817845876,
    -292,  860541660,   292,   -860541660,  1636,  61928036,
    -1636, -61928036,   -1006, -300609006,  1006,  300609006,
    865,   -975366559,  -865,  975366559,   864,   1513366368,
    -864,  -1513366368, 1270,  405112566,   -1270, -405112566,
    -1310, 359956706,   1310,  -359956706,  491,   2097812203,
    -491,  -2097812203, 44,    -2130066388, -44,   2130066388,
    -1569, 696690399,   1569,  -696690399,  334,   1986857806,
    -334,  -1986857806, -1088, 1912028096,  1088,  -1912028096,
    -267,  -1228239371, 267,   1228239371,  -693,  -1884934581,
    693,   1884934581,  243,   828287475,   -243,  -828287475,
    -1211, -1211467195, 1211,  1211467195,  122,   1317260922,
    -122,  -1317260922, 1551,  1150829327,  -1551, -1150829327,
    -1495, 1214047529,  1495,  -1214047529, -293,  -945692709,
    293,   945692709,   -589,  1279846067,  589,   -1279846067,
    -257,  -345764865,  257,   345764865,   -1596, -826997308,
    1596,  826997308,   -724,  -2043625172, 724,   2043625172,
    -92,   1330162596,  92,    -1330162596, -351,  1666896289,
    351,   -1666896289, -1001, 140628247,   1001,  -140628247,
    1367,  -483812777,  -1367, 483812777,   -47,   1006330577,
    47,    -1006330577, 1449,  1598517417,  -1449, -1598517417,
    -1416, -2122325384, 1416,  2122325384,  111,   -1371447953,
    -111,  1371447953,  -1163, -411563403,  1163,  411563403,
    86,    717333078,   -86,   -717333078,  -1111, -976656727,
    1111,  976656727,   310,   1586905910,  -310,  -1586905910,
    21,    -723783915,  -21,   723783915,   840,   1113414472,
    -840,  -1113414472, 916,   948273044,   -916,  -948273044,
    -1248, 677337888,   1248,  -677337888,  -600,  -1408862808,
    600,   1408862808,  -697,  -519937465,  697,   519937465,
    -15,   -1323711759, 15,    1323711759,  -1506, -1474661346,
    1506,  1474661346,  -596,  1521107372,  596,   -1521107372,
    -537,  714752743,   537,   -714752743,  318,   -1143088322,
    -318,  1143088322,  -434,  2073299022,  434,   -2073299022,
    -1361, -1563682897, 1361,  1563682897,  -1176, 1877193576,
    1176,  -1877193576, 715,   -1327582261, -715,  1327582261,
    -1452, 1572714068,  1452,  -1572714068, -442,  508325958,
    442,   -508325958,  -1035, -1141798155, 1035,  1141798155,
    1487,  1515946703,  -1487, -1515946703,
};

int16_t montgomery_reduce_ref(int32_t a)
{
    int16_t t;
    int16_t qinv = -3327;  // q^-1 mod 2^16

    t = (int16_t)a * qinv;
    t = (a - (int32_t)t * KYBER_Q) >> 16;
    return t;
}

int32_t montgomery_reduce_beta32(int64_t a)
{
    int32_t t;
    int32_t qinv = 1806234369;  // q^-1 mod 2^32

    t = (int32_t)a * qinv;
    t = (a - (int64_t)t * KYBER_Q) >> 32;
    return t;
}

int16_t barrett_reduce_ref(int16_t a)
{
    int16_t t;
    const int16_t v = ((1 << 26) + KYBER_Q / 2) / KYBER_Q;

    t = ((int32_t)v * a + (1 << 25)) >> 26;
    t *= KYBER_Q;
    return a - t;
}

static int16_t fqmul(int16_t a, int16_t b)
{
    return montgomery_reduce_ref((int32_t)a * b);
}

static int16_t fqmul_beta32(int32_t a, int32_t b)
{
    return montgomery_reduce_beta32((int64_t)a * b);
}

void ntt_ref(int16_t r[256])
{
    unsigned int len, start, j, k;
    int16_t t, zeta;

    k = 1;
    for (len = 128; len >= 2; len >>= 1) {
        for (start = 0; start < 256; start = j + len) {
            zeta = zetas_ref[k++];
            for (j = start; j < start + len; j++) {
                t = fqmul(zeta, r[j + len]);
                r[j + len] = r[j] - t;
                r[j] = r[j] + t;
            }
        }
    }
}

void intt_ref(int16_t r[256])
{
    unsigned int start, len, j, k;
    int16_t t, zeta;
    const int16_t f = 1441;  // mont^2/128

    k = 127;
    for (len = 2; len <= 128; len <<= 1) {
        for (start = 0; start < 256; start = j + len) {
            zeta = zetas_ref[k--];
            for (j = start; j < start + len; j++) {
                t = r[j];
                r[j] = barrett_reduce_ref(t + r[j + len]);
                r[j + len] = r[j + len] - t;
                r[j + len] = fqmul(zeta, r[j + len]);
            }
        }
    }

    for (j = 0; j < 256; j++)
        r[j] = fqmul(r[j], f);
}

void basemul_ref(int16_t r[2], const int16_t a[2], const int16_t b[2],
                 int16_t zeta)
{
    r[0] = fqmul(a[1], b[1]);
    r[0] = fqmul(r[0], zeta);
    r[0] += fqmul(a[0], b[0]);
    r[1] = fqmul(a[0], b[1]);
    r[1] += fqmul(a[1], b[0]);
}

void basemul_beta32(int16_t r[2], const int16_t a[2], const int16_t b[2],
                    int32_t zeta)
{
    r[0] = fqmul_beta32(a[1], b[1]);
    r[0] = fqmul_beta32(r[0], zeta);
    r[0] += fqmul_beta32(a[0], b[0]);
    r[1] = fqmul_beta32(a[0], b[1]);
    r[1] += fqmul_beta32(a[1], b[0]);
}

void poly_basemul_ref(int16_t *r, int16_t *a, int16_t *b)
{
    unsigned int i;
    for (i = 0; i < KYBER_N / 4; i++) {
        basemul_ref(&r[4 * i], &a[4 * i], &b[4 * i], zetas_ref[64 + i]);
        basemul_ref(&r[4 * i + 2], &a[4 * i + 2], &b[4 * i + 2],
                    -zetas_ref[64 + i]);
    }
}

void poly_tomont_ref(int16_t *r)
{
    unsigned int i;
    const int16_t f = (1ULL << 32) % KYBER_Q;
    for (i = 0; i < KYBER_N; i++)
        r[i] = montgomery_reduce_ref((int32_t)r[i] * f);
}

void poly_basemul_beta32(int16_t *r, int16_t *a, int16_t *b)
{
    unsigned int i;
    for (i = 0; i < KYBER_N / 4; i++) {
        basemul_beta32(&r[4 * i], &a[4 * i], &b[4 * i],
                       basemul_zetas_133merging[4 * i]);
        basemul_beta32(&r[4 * i + 2], &a[4 * i + 2], &b[4 * i + 2],
                       basemul_zetas_133merging[4 * i + 2]);
    }
}

void poly_tomont_beta32(int16_t *r)
{
    unsigned int i;
    const int16_t f = 2988;
    for (i = 0; i < KYBER_N; i++)
        r[i] = montgomery_reduce_beta32((int32_t)r[i] * f);
}

void print_poly(int16_t *a, size_t n)
{
    int i;
    for (i = 0; i < n; i++) {
        if (i != 0 && i % 16 == 0)
            printf("\n");
        printf("%d, ", a[i]);
    }
    printf("\n\n");
}

int poly_equal(int16_t *a, int16_t *b, size_t n)
{
    size_t i;
    int ok = 1;
    for (i = 0; i < n; i++) {
        if (((a[i] + KYBER_Q * 10) % KYBER_Q) !=
            ((b[i] + KYBER_Q * 10) % KYBER_Q)) {
            ok = 0;
            break;
        }
    }
    return ok;
}

#define NTESTS 1000
uint64_t t[NTESTS];

void ntt_rv32im(int16_t in[256], const int32_t zetas[128 * 2]);
void intt_rv32im(int16_t in[256], const int32_t zetas[128 * 2]);

int main()
{
    int16_t a[KYBER_N], b[KYBER_N], c0[KYBER_N], c1[KYBER_N], i, j;

    for (i = 0; i < KYBER_N; i++)
        a[i] = 1;
    for (i = 0; i < KYBER_N; i++)
        b[i] = 1;
    ntt_ref(a);
    ntt_rv32im(b, ntt_zetas_133merging);
    if (poly_equal(a, b, KYBER_N) != 1) {
        print_poly(a, KYBER_N);
        print_poly(b, KYBER_N);
    }

    for (i = 0; i < KYBER_N; i++)
        a[i] = 1;
    for (i = 0; i < KYBER_N; i++)
        b[i] = 1;
    ntt_ref(a);
    ntt_rv32im(b, ntt_zetas_133merging);
    for (i = 0; i < KYBER_N; i++)
        a[i] = montgomery_reduce_ref(a[i]);
    for (i = 0; i < KYBER_N; i++)
        b[i] = montgomery_reduce_beta32(b[i]);
    // poly_basemul_ref(c0, a, b);
    // poly_basemul_beta32(c1, a, b);
    intt_ref(a);
    intt_rv32im(b, intt_zetas_133merging);
    if (poly_equal(a, b, KYBER_N) != 1) {
        print_poly(a, KYBER_N);
        print_poly(b, KYBER_N);
    }

    for (i = 0; i < KYBER_N; i++)
        a[i] = KYBER_Q - 1;
    for (i = 0; i < KYBER_N; i++)
        b[i] = KYBER_Q - 1;
    intt_ref(a);
    intt_rv32im(b, intt_zetas_133merging);
    for (i = 0; i < KYBER_N; i++)
        a[i] = montgomery_reduce_ref(a[i]);
    for (i = 0; i < KYBER_N; i++)
        b[i] = montgomery_reduce_beta32(b[i]);
    if (poly_equal(a, b, KYBER_N) != 1) {
        print_poly(a, KYBER_N);
        print_poly(b, KYBER_N);
    }

    for (i = 0; i < KYBER_N; i++)
        a[i] = 1;
    for (i = 0; i < KYBER_N; i++)
        b[i] = 1;
    ntt_ref(a);
    ntt_rv32im(b, ntt_zetas_133merging);
    poly_basemul_ref(c0, a, b);
    poly_basemul_beta32(c1, a, b);
    intt_ref(c0);
    intt_rv32im(c1, intt_zetas_133merging);
    if (poly_equal(c0, c1, KYBER_N) != 1) {
        print_poly(c0, KYBER_N);
        print_poly(c1, KYBER_N);
    }

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        ntt_rv32im(b, ntt_zetas_133merging);
    }
    print_results("ntt_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        intt_rv32im(b, intt_zetas_133merging);
    }
    print_results("intt_rv32im:", t, NTESTS);

    return 0;
}