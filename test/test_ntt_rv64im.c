#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "cpucycles.h"
#include "ntt_rv64im.h"
#include "speed_print.h"

#define KYBER_N 256
#define KYBER_Q 3329
#define KYBER_K 2

typedef struct {
    int16_t coeffs[KYBER_N >> 1];
} poly_half;

typedef struct {
    int32_t coeffs[KYBER_N];
} poly_double;

typedef struct {
    int16_t coeffs[KYBER_N];
} poly;

typedef struct {
    poly vec[KYBER_K];
} polyvec;

typedef struct {
    poly_half vec[KYBER_K];
} polyvec_half;

uint64_t zetas_basemul_rv64im[64] = {
    94200855888573859,    -3147416832041761886, 3230535234296385879,
    -3768034235542954370, 9070988299387965153,  4006306988672876485,
    -5768417116470905146, 6095349498672426187,  7807588585117680453,
    -3695998286922280243, -265978887214796779,  1291105848355159365,
    4189167473633049271,  -6499859056311596289, -1739945220530128930,
    -1546002281936006278, -9010034804401240891, 9148565474825614214,
    -2992262481166463765, -8533489298141396662, -8212098142756850554,
    5275247929760136118,  8095732379600376963,  -3557467616497906920,
    5203211981139461991,  -5657592580131406488, -4942774320741640145,
    -5214294434773411857, 4061719256842625814,  -5496897002439133434,
    1485048786949282017,  3551926389680931987,  8777303278088293710,
    -5713004848301155817, -7159265047531613304, -603993723050267686,
    2077960056365599837,  -4322156917240447660, -6865580026231941860,
    9115318113923764616,  5890324106444353670,  1767651354615003594,
    -3080922110238062691, 4194708700450024203,  -6815708984879167464,
    3108628244322937356,  -4782078743049367091, -4072801710476575680,
    -2909144078911839771, 6051019684136626724,  2233114407240897958,
    5685298714216281153,  6333622251802348302,  -6533106417213445886,
    -3069839656604112825, 4909526959839790547,  -8904751494878717166,
    6715966902173618672,  -8062485018698527366, 5701922394667205952,
    -6754755489892443202, -2183243365888123562, 4903985733022815614,
    -6510941509945546155};

// 4+3 layer merging strategy with CT butterfly
uint64_t zetas_ntt_rv64im[128] = {-8865962907159892636, -4150378885914224740,
                                  -221649072678997316,  -3806822823261778901,
                                  3490972894694207725,  -7935036801908103909,
                                  4698960340794743097,  5884782879627378737,
                                  -7813129811934655386, 1069456775676162049,
                                  4416357773129021519,  -3008886161617388563,
                                  -382344650371270370,  3152958058858736819,
                                  -8771762051271318777, 1640203137824580138,
                                  1601414550105755607,  1834146076418702789,
                                  94200855888573859,    -3147416832041761886,
                                  3230535234296385879,  -3768034235542954370,
                                  -4887362052571890816, -421133238090094900,
                                  -8716349783101569448, 9070988299387965153,
                                  4006306988672876485,  -5768417116470905146,
                                  6095349498672426187,  7419702707929435150,
                                  6632848499918994678,  -5679757487399306220,
                                  7807588585117680453,  -3695998286922280243,
                                  -265978887214796779,  1291105848355159365,
                                  8178850781855000957,  -5829370611457629408,
                                  -7059522964826064512, 4189167473633049271,
                                  -6499859056311596289, -1739945220530128930,
                                  -1546002281936006278, -1568167189203906010,
                                  3601797431033706383,  -7491738656550109278,
                                  -9010034804401240891, 9148565474825614214,
                                  -2992262481166463765, -8533489298141396662,
                                  310308701750596242,   -4521641082651545244,
                                  3502055348328157591,  -8212098142756850554,
                                  5275247929760136118,  8095732379600376963,
                                  -3557467616497906920, -6034396003685701925,
                                  -2571129243076368864, 182860484960172786,
                                  5203211981139461991,  -5657592580131406488,
                                  -4942774320741640145, -5214294434773411857,
                                  7386455347027585552,  7314419398406911425,
                                  -7835294719202555117, 4061719256842625814,
                                  -5496897002439133434, 1485048786949282017,
                                  3551926389680931987,  7901789441006254312,
                                  -5596639085144682227, 7951660482359028708,
                                  8777303278088293710,  -5713004848301155817,
                                  -7159265047531613304, -603993723050267686,
                                  -6843415118964042128, 4471770041298770848,
                                  2504634521272669670,  2077960056365599837,
                                  -4322156917240447660, -6865580026231941860,
                                  9115318113923764616,  2964556347081589100,
                                  7968284162809953507,  -2554505562625444066,
                                  5890324106444353670,  1767651354615003594,
                                  -3080922110238062691, 4194708700450024203,
                                  -2476928387187795005, 8500241937239547065,
                                  -5136717259335762796, -6815708984879167464,
                                  3108628244322937356,  -4782078743049367091,
                                  -4072801710476575680, -5186588300688537192,
                                  -3779116689176904236, -3945353493686152223,
                                  -2909144078911839771, 6051019684136626724,
                                  2233114407240897958,  5685298714216281153,
                                  -2493552067638719804, 8206556915939875621,
                                  3590714977399756518,  6333622251802348302,
                                  -6533106417213445886, -3069839656604112825,
                                  4909526959839790547,  -7508362337001034076,
                                  -4737748928513567627, -1213528672917510305,
                                  -8904751494878717166, 6715966902173618672,
                                  -8062485018698527366, 5701922394667205952,
                                  4549347216736419909,  6799085304428242665,
                                  5042516403447188937,  -6754755489892443202,
                                  -2183243365888123562, 4903985733022815614,
                                  -6510941509945546155, 0};

// 3+4 layer merging strategy with GS butterfly.
uint64_t zetas_intt_rv64im[128] = {
    6510941509945546155,  -4903985733022815614, 2183243365888123562,
    6754755489892443202,  -5042516403447188937, -6799085304428242665,
    -4549347216736419909, -5701922394667205952, 8062485018698527366,
    -6715966902173618672, 8904751494878717166,  1213528672917510305,
    4737748928513567627,  7508362337001034076,  -4909526959839790547,
    3069839656604112825,  6533106417213445886,  -6333622251802348302,
    -3590714977399756518, -8206556915939875621, 2493552067638719804,
    -5685298714216281153, -2233114407240897958, -6051019684136626724,
    2909144078911839771,  3945353493686152223,  3779116689176904236,
    5186588300688537192,  4072801710476575680,  4782078743049367091,
    -3108628244322937356, 6815708984879167464,  5136717259335762796,
    -8500241937239547065, 2476928387187795005,  -4194708700450024203,
    3080922110238062691,  -1767651354615003594, -5890324106444353670,
    2554505562625444066,  -7968284162809953507, -2964556347081589100,
    -9115318113923764616, 6865580026231941860,  4322156917240447660,
    -2077960056365599837, -2504634521272669670, -4471770041298770848,
    6843415118964042128,  603993723050267686,   7159265047531613304,
    5713004848301155817,  -8777303278088293710, -7951660482359028708,
    5596639085144682227,  -7901789441006254312, -3551926389680931987,
    -1485048786949282017, 5496897002439133434,  -4061719256842625814,
    7835294719202555117,  -7314419398406911425, -7386455347027585552,
    5214294434773411857,  4942774320741640145,  5657592580131406488,
    -5203211981139461991, -182860484960172786,  2571129243076368864,
    6034396003685701925,  3557467616497906920,  -8095732379600376963,
    -5275247929760136118, 8212098142756850554,  -3502055348328157591,
    4521641082651545244,  -310308701750596242,  8533489298141396662,
    2992262481166463765,  -9148565474825614214, 9010034804401240891,
    7491738656550109278,  -3601797431033706383, 1568167189203906010,
    1546002281936006278,  1739945220530128930,  6499859056311596289,
    -4189167473633049271, 7059522964826064512,  5829370611457629408,
    -8178850781855000957, -1291105848355159365, 265978887214796779,
    3695998286922280243,  -7807588585117680453, 5679757487399306220,
    -6632848499918994678, -7419702707929435150, -6095349498672426187,
    5768417116470905146,  -4006306988672876485, -9070988299387965153,
    8716349783101569448,  421133238090094900,   4887362052571890816,
    3768034235542954370,  -3230535234296385879, 3147416832041761886,
    -94200855888573859,   -1834146076418702789, -1601414550105755607,
    -1640203137824580138, 8771762051271318777,  -3152958058858736819,
    382344650371270370,   3008886161617388563,  -4416357773129021519,
    -1069456775676162049, 7813129811934655386,  -5884782879627378737,
    -4698960340794743097, 7935036801908103909,  -3490972894694207725,
    3806822823261778901,  221649072678997316,   4150378885914224740,
    -4050636803208675948, 6211715261828899778};

void ntt(poly *poly)
{
    ntt_rv64im(poly->coeffs, zetas_ntt_rv64im);
}

void intt(poly *poly)
{
    intt_rv64im(poly->coeffs, zetas_intt_rv64im);
}

void poly_basemul_acc(poly_double *r, const poly *a, const poly *b)
{
    poly_basemul_acc_rv64im(r->coeffs, a->coeffs, b->coeffs,
                            zetas_basemul_rv64im);
}

void poly_basemul_acc_end(poly *r, const poly *a, const poly *b,
                          poly_double *r_double)
{
    poly_basemul_acc_end_rv64im(r->coeffs, a->coeffs, b->coeffs,
                                zetas_basemul_rv64im, r_double->coeffs);
}

void print_poly(int16_t *a, size_t n)
{
    int i;
    for (i = 0; i < n; i++) {
        if (i != 0 && i % 8 == 0)
            printf("\n");
        printf("%d, ", a[i]);
    }
    printf("\n\n");
}

int poly_equal(int16_t *a, int16_t *b, size_t n)
{
    size_t i;
    int ok = 1;
    for (i = 0; i < n; i++) {
        if (((a[i] + 3329 * 10) % 3329) != ((b[i] + 3329 * 10) % 3329)) {
            ok = 0;
            break;
        }
    }
    return ok;
}

void test_ntt()
{
    int i;
    poly a;
    for (i = 0; i < KYBER_N; i++)
        a.coeffs[i] = i;

    ntt_rv64im(a.coeffs, zetas_ntt_rv64im);
    intt_rv64im(a.coeffs, zetas_intt_rv64im);
    print_poly(a.coeffs, KYBER_N);
}

void test_ntt2()
{
    int i;
    poly a, b, c;
    poly_double c_double;
    for (i = 0; i < KYBER_N; i++)
        a.coeffs[i] = b.coeffs[i] = c_double.coeffs[i] = 0;
    a.coeffs[0] = b.coeffs[0] = 100;

    ntt(&a);
    ntt(&b);
    poly_basemul_acc(&c_double, &a, &b);
    poly_basemul_acc_end(&c, &a, &b, &c_double);
    intt(&c);
    // poly_toplant(a);
    print_poly(c.coeffs, 256);
}

extern void plant_mul_rv64im(int16_t *in, int64_t *zeta);

void test_table()
{
    int i;
    int16_t t;
    for (i = 0; i < 127; i++) {
        t = 0x7fff;
        plant_mul_rv64im(&t, &zetas_ntt_rv64im[i]);
        printf("%d, ", t);
    }
    printf("\n");

    for (i = 0; i < 64; i++) {
        t = 0x7fff;
        plant_mul_rv64im(&t, &zetas_basemul_rv64im[i]);
        printf("%d, ", t);
    }
    printf("\n");

    for (i = 0; i < 128; i++) {
        t = 0x7fff;
        plant_mul_rv64im(&t, &zetas_intt_rv64im[i]);
        printf("%d, ", t);
    }
    printf("\n");
}

int main()
{
    // test_ntt();
    test_ntt2();
    // test_table();
    return 0;
}