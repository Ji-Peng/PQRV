#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "cpucycles.h"
#include "ntt_rv32im.h"
#include "speed_print.h"

#define N 256
#define Q 8380417
#define ROOT_OF_UNITY 1753
#define MONT -4186625   // 2^32 % Q
#define R2modQ 2365951  // 2^64 % Q
#define QINV 58728449   // q^(-1) mod 2^32
#define INVN -32736     // N^-1 mod Q

int32_t zetas_ntt[] = {
    25847,    -2608894, -518909,  237124,   -777960,  -876248,  466468,
    1826347,  2353451,  -359251,  -2091905, 3119733,  -2884855, 3111497,
    2680103,  2725464,  1024112,  -1079900, 3585928,  -549488,  -1119584,
    2619752,  -2108549, -2118186, -3859737, -1399561, -3277672, 1757237,
    -19422,   4010497,  280005,   2706023,  95776,    3077325,  3530437,
    -1661693, -3592148, -2537516, 3915439,  -3861115, -3043716, 3574422,
    -2867647, 3539968,  -300467,  2348700,  -539299,  -1699267, -1643818,
    3505694,  -3821735, 3507263,  -2140649, -1600420, 3699596,  811944,
    531354,   954230,   3881043,  3900724,  -2556880, 2071892,  -2797779};

int32_t zetas_intt[] = {
    2797779,  -2071892, 2556880,  -3900724, -3881043, -954230,  -531354,
    -811944,  -3699596, 1600420,  2140649,  -3507263, 3821735,  -3505694,
    1643818,  1699267,  539299,   -2348700, 300467,   -3539968, 2867647,
    -3574422, 3043716,  3861115,  -3915439, 2537516,  3592148,  1661693,
    -3530437, -3077325, -95776,   -2706023, -280005,  -4010497, 19422,
    -1757237, 3277672,  1399561,  3859737,  2118186,  2108549,  -2619752,
    1119584,  549488,   -3585928, 1079900,  -1024112, -2725464, -2680103,
    -3111497, 2884855,  -3119733, 2091905,  359251,   -2353451, -1826347,
    -466468,  876248,   777960,   -237124,  518909,   2608894,  -25847};

int32_t zetas_basemul[] = {
    2706023,  95776,    3077325,  3530437,  -1661693, -3592148, -2537516,
    3915439,  -3861115, -3043716, 3574422,  -2867647, 3539968,  -300467,
    2348700,  -539299,  -1699267, -1643818, 3505694,  -3821735, 3507263,
    -2140649, -1600420, 3699596,  811944,   531354,   954230,   3881043,
    3900724,  -2556880, 2071892,  -2797779};

int32_t zetas_33merging_ntt[] = {
    25847,    1830765815,  -2608894, -1929875198, -518909,  -1927777021,
    237124,   1640767044,  -777960,  1477910808,  -876248,  1612161320,
    466468,   1640734244,  1826347,  308362795,   2725464,  1727305304,
    1024112,  2082316400,  2706023,  -1846138265, 95776,    -1631226336,
    3077325,  -1404529459, 3530437,  1838055109,  2353451,  -1815525077,
    -1079900, -1364982364, 3585928,  858240904,   -1661693, 1594295555,
    -3592148, -1076973524, -2537516, -1898723372, 3915439,  -594436433,
    -359251,  -1374673747, -549488,  1806278032,  -1119584, 222489248,
    -3861115, -202001019,  -3043716, -475984260,  3574422,  -561427818,
    -2867647, 1797021249,  -2091905, -1091570561, 2619752,  -346752664,
    -2108549, 684667771,   3539968,  -1061813248, -300467,  2059733581,
    2348700,  -1661512036, -539299,  -1104976547, 3119733,  -1929495947,
    -2118186, 1654287830,  -3859737, -878576921,  -1699267, -1750224323,
    -1643818, -901666090,  3505694,  418987550,   -3821735, 1831915353,
    -2884855, 515185417,   -1399561, -1257667337, -3277672, -748618600,
    3507263,  -1925356481, -2140649, 992097815,   -1600420, 879957084,
    3699596,  2024403852,  3111497,  -285697463,  1757237,  329347125,
    -19422,   1837364258,  811944,   1484874664,  531354,   -1636082790,
    954230,   -285388938,  3881043,  -1983539117, 2680103,  625853735,
    4010497,  -1443016191, 280005,   -1170414139, 3900724,  -1495136972,
    -2556880, -950076368,  2071892,  -1714807468, -2797779, -952438995,
};

int32_t zetas_33merging_intt[] = {
    2797779,  952438995,   -2071892, 1714807468,  2556880,  950076368,
    -3900724, 1495136972,  -280005,  1170414139,  -4010497, 1443016191,
    -2680103, -625853735,  -3881043, 1983539117,  -954230,  285388938,
    -531354,  1636082790,  -811944,  -1484874664, 19422,    -1837364258,
    -1757237, -329347125,  -3111497, 285697463,   -3699596, -2024403852,
    1600420,  -879957084,  2140649,  -992097815,  -3507263, 1925356481,
    3277672,  748618600,   1399561,  1257667337,  2884855,  -515185417,
    3821735,  -1831915353, -3505694, -418987550,  1643818,  901666090,
    1699267,  1750224323,  3859737,  878576921,   2118186,  -1654287830,
    -3119733, 1929495947,  539299,   1104976547,  -2348700, 1661512036,
    300467,   -2059733581, -3539968, 1061813248,  2108549,  -684667771,
    -2619752, 346752664,   2091905,  1091570561,  2867647,  -1797021249,
    -3574422, 561427818,   3043716,  475984260,   3861115,  202001019,
    1119584,  -222489248,  549488,   -1806278032, 359251,   1374673747,
    -3915439, 594436433,   2537516,  1898723372,  3592148,  1076973524,
    1661693,  -1594295555, -3585928, -858240904,  1079900,  1364982364,
    -2353451, 1815525077,  -3530437, -1838055109, -3077325, 1404529459,
    -95776,   1631226336,  -2706023, 1846138265,  -1024112, -2082316400,
    -2725464, -1727305304, -1826347, -308362795,  -466468,  -1640734244,
    876248,   -1612161320, 777960,   -1477910808, -237124,  -1640767044,
    518909,   1927777021,  2608894,  1929875198,  -857982,  604186754,
};

int32_t zetas_33merging_basemul[] = {
    2706023,  -1846138265, 95776,    -1631226336, 3077325,  -1404529459,
    3530437,  1838055109,  -1661693, 1594295555,  -3592148, -1076973524,
    -2537516, -1898723372, 3915439,  -594436433,  -3861115, -202001019,
    -3043716, -475984260,  3574422,  -561427818,  -2867647, 1797021249,
    3539968,  -1061813248, -300467,  2059733581,  2348700,  -1661512036,
    -539299,  -1104976547, -1699267, -1750224323, -1643818, -901666090,
    3505694,  418987550,   -3821735, 1831915353,  3507263,  -1925356481,
    -2140649, 992097815,   -1600420, 879957084,   3699596,  2024403852,
    811944,   1484874664,  531354,   -1636082790, 954230,   -285388938,
    3881043,  -1983539117, 3900724,  -1495136972, -2556880, -950076368,
    2071892,  -1714807468, -2797779, -952438995,
};

int32_t zetas_ntt_8l_rv32im[256 * 2] = {
    25847,    1830765815,  -2608894, -1929875198, -518909,  -1927777021,
    237124,   1640767044,  -777960,  1477910808,  -876248,  1612161320,
    466468,   1640734244,  1826347,  308362795,   2725464,  1727305304,
    1024112,  2082316400,  2706023,  -1846138265, 95776,    -1631226336,
    3077325,  -1404529459, 3530437,  1838055109,  2353451,  -1815525077,
    -1079900, -1364982364, 3585928,  858240904,   -1661693, 1594295555,
    -3592148, -1076973524, -2537516, -1898723372, 3915439,  -594436433,
    -359251,  -1374673747, -549488,  1806278032,  -1119584, 222489248,
    -3861115, -202001019,  -3043716, -475984260,  3574422,  -561427818,
    -2867647, 1797021249,  -2091905, -1091570561, 2619752,  -346752664,
    -2108549, 684667771,   3539968,  -1061813248, -300467,  2059733581,
    2348700,  -1661512036, -539299,  -1104976547, 3119733,  -1929495947,
    -2118186, 1654287830,  -3859737, -878576921,  -1699267, -1750224323,
    -1643818, -901666090,  3505694,  418987550,   -3821735, 1831915353,
    -2884855, 515185417,   -1399561, -1257667337, -3277672, -748618600,
    3507263,  -1925356481, -2140649, 992097815,   -1600420, 879957084,
    3699596,  2024403852,  3111497,  -285697463,  1757237,  329347125,
    -19422,   1837364258,  811944,   1484874664,  531354,   -1636082790,
    954230,   -285388938,  3881043,  -1983539117, 2680103,  625853735,
    4010497,  -1443016191, 280005,   -1170414139, 3900724,  -1495136972,
    -2556880, -950076368,  2071892,  -1714807468, -2797779, -952438995,
    -3930395, -1574918427, 2091667,  -898413,     3407706,  991903578,
    -1528703, -654783359,  2316500,  1363007700,  3817976,  746144248,
    -3677745, 1350681039,  -3342478, -1363460238, 2244091,  912367099,
    -3041255, -1974159335, -2446433, 30313375,    -3562462, -1420958686,
    -1452451, -2143979939, 266997,   -605900043,  2434439,  -44694137,
    3475950,  1651689966,  -1235728, -326425360,  3513181,  2032221021,
    2176455,  1599739335,  -3520352, 2027833504,  -3759364, 1176904444,
    -1585221, 140455867,   -1197226, 1683520342,  -3193378, 1904936414,
    -1257611, -1285853323, 900702,   14253662,    1859098,  -421552614,
    1939314,  -1039411342, 909542,   -517299994,  819034,   1257750362,
    -4083598, -993005454,  495491,   1014493059,  -1613174, -818371958,
    -1000202, 1955560694,  -43260,   2027935492,  -522500,  1926727420,
    -3190144, -1440787840, -655327,  863641633,   -3122442, 1747917558,
    -3157330, 1529189038,  2031748,  -1372618620, 3207046,  1931587462,
    -3632928, 568627424,   -3556995, 1819892093,  -525098,  -325927722,
    126922,   -2131021878, -768622,  128353682,   -3595838, 1258381762,
    3412210,  -783134478,  342297,   2124962073,  286988,   908452108,
    -983419,  -247357819,  -2437823, -1123881663, 4108315,  885133339,
    2147896,  -588790216,  3437287,  -1223601433, -3342277, 1851023419,
    2715295,  1518161567,  1735879,  137583815,   203044,   1629985060,
    -2967645, 289871779,   2842341,  -1920467227, 2691481,  -1176751719,
    -3693493, -86965173,   -2590150, -635454918,  1265009,  1967222129,
    -411027,  -1262003603, 4055324,  -1637785316, 1247620,  -1354528380,
    -2477047, 1708872713,  2486353,  -642772911,  1595974,  6363718,
    -671102,  2135294594,  -3767016, -1536588520, 1250494,  -72690498,
    -1228525, 1787797779,  2635921,  45766801,    -3548272, -1287922800,
    -22981,   -1018755525, -2994039, 694382729,   1869119,  -314284737,
    -1308169, 1638590967,  1903435,  671509323,   -1050970, 1136965286,
    -381987,  -889861155,  -1333058, 235104446,   1237275,  985022747,
    1349076,  -120646188,  -3318210, -2070602178, -1430225, 1779436847,
    1852771,  1665705315,  -451100,  -1045062172, 1312455,  963438279,
    -1430430, -1669960606, 3306115,  419615363,   -1962642, 1116720494,
    -3343383, 1321868265,  -1279661, 831969619,   1917081,  -1078959975,
    264944,   -916321552,  -2546312, 1216882040,  -1374803, 1042326957,
    508951,   1225434135,  1500165,  -300448763,  777191,   604552167,
    3097992,  1155548552,  2235880,  -270590488,  3406031,  1405999311,
    44288,    -1784632064, -542412,  756955444,   -2831860, -1021949428,
    -1100098, 2143745726,  -1671176, -1276805128, -1846953, 713994583,
    904516,   666258756,   -2584293, -260312805,  -3724270, 608791570,
    3958618,  1210558298,  594136,   371462360,   -3776993, 940195359,
    -3724342, 675310538,   -2013608, 1554794072,  2432395,  173440395,
    -8578,    -1261461890, 2454455,  -1357098057, -164721,  -1542497137,
    1653064,  -1555941048, 1957272,  1339088280,  3369112,  -2126092136,
    -3249728, -318346816,  185531,   -384158533,  -1207385, 2061661095,
    2389356,  -1999506068, -3183426, -2040058690, 162844,   -1316619236,
    -210977,  628664287,   1616392,  827959816,   3014001,  -883155599,
    759969,   -1499481951, 810149,   -853476187,  1652634,  -1039370342,
    -1316856, -1729304568, -3694233, -596344473,  -1799107, 1726753853,
    189548,   -695180180,  -3038916, -2047270596, 3523897,  6087993,
    -3553272, 1422575624,  3866901,  702390549,   269760,   -1547952704,
    3159746,  -1375177022, 2213111,  -1723816713, -975884,  -110126092,
    -1851402, 1424130038,  1717735,  -279505433,  472078,   394851342,
    -2409325, 1777179795,  -426683,  -1591599803, 1723600,  565464272,
    -177440,  -1185330464, -1803090, -260424530,  1910376,  283780712,
    1315589,  334803717,   -1667432, -440824168,  -1104333, -1758099917,
    1341330,  235321234,   -260646,  -71875110,   -3833893, 776003547,
    1285669,  -178766299,  -2939036, 1119856484,  -2235985, -1600929361,
    -1584928, 168022240,   -420899,  -1208667171, -2286327, 1123958025,
    -812732,  -518252220,  183443,   1544891539,  -976891,  879867909,
    -1439742, 1206536194,  1612842,  -1499603926, -3545687, 201262505,
    -3019102, 1957047970,  -554416,  155290192,   3919660,  -1809756372,
    -3881060, 985155484,   -48306,   2036925262,  -1362209, 1934038751,
    -3628969, 1146323031,  3937738,  -973777462,  1400424,  400711272,
    3839961,  -894060583,  -846154,  -540420426,  1976782,  374860238,
};

int32_t zetas_intt_8l_rv32im[256 * 2] = {
    -1976782, -374860238,  846154,   540420426,   -3839961, 894060583,
    -1400424, -400711272,  -3937738, 973777462,   3628969,  -1146323031,
    1362209,  -1934038751, 48306,    -2036925262, 3881060,  -985155484,
    -3919660, 1809756372,  554416,   -155290192,  3019102,  -1957047970,
    3545687,  -201262505,  -1612842, 1499603926,  1439742,  -1206536194,
    976891,   -879867909,  -183443,  -1544891539, 812732,   518252220,
    2286327,  -1123958025, 420899,   1208667171,  1584928,  -168022240,
    2235985,  1600929361,  2939036,  -1119856484, -1285669, 178766299,
    3833893,  -776003547,  260646,   71875110,    -1341330, -235321234,
    1104333,  1758099917,  1667432,  440824168,   -1315589, -334803717,
    -1910376, -283780712,  1803090,  260424530,   177440,   1185330464,
    -1723600, -565464272,  426683,   1591599803,  2409325,  -1777179795,
    -472078,  -394851342,  -1717735, 279505433,   1851402,  -1424130038,
    975884,   110126092,   -2213111, 1723816713,  -3159746, 1375177022,
    -269760,  1547952704,  -3866901, -702390549,  3553272,  -1422575624,
    -3523897, -6087993,    3038916,  2047270596,  -189548,  695180180,
    1799107,  -1726753853, 3694233,  596344473,   1316856,  1729304568,
    -1652634, 1039370342,  -810149,  853476187,   -759969,  1499481951,
    -3014001, 883155599,   -1616392, -827959816,  210977,   -628664287,
    -162844,  1316619236,  3183426,  2040058690,  -2389356, 1999506068,
    1207385,  -2061661095, -185531,  384158533,   3249728,  318346816,
    -3369112, 2126092136,  -1957272, -1339088280, -1653064, 1555941048,
    164721,   1542497137,  -2454455, 1357098057,  8578,     1261461890,
    -2432395, -173440395,  2013608,  -1554794072, 3724342,  -675310538,
    3776993,  -940195359,  -594136,  -371462360,  -3958618, -1210558298,
    3724270,  -608791570,  2584293,  260312805,   -904516,  -666258756,
    1846953,  -713994583,  1671176,  1276805128,  1100098,  -2143745726,
    2831860,  1021949428,  542412,   -756955444,  -44288,   1784632064,
    -3406031, -1405999311, -2235880, 270590488,   -3097992, -1155548552,
    -777191,  -604552167,  -1500165, 300448763,   -508951,  -1225434135,
    1374803,  -1042326957, 2546312,  -1216882040, -264944,  916321552,
    -1917081, 1078959975,  1279661,  -831969619,  3343383,  -1321868265,
    1962642,  -1116720494, -3306115, -419615363,  1430430,  1669960606,
    -1312455, -963438279,  451100,   1045062172,  -1852771, -1665705315,
    1430225,  -1779436847, 3318210,  2070602178,  -1349076, 120646188,
    -1237275, -985022747,  1333058,  -235104446,  381987,   889861155,
    1050970,  -1136965286, -1903435, -671509323,  1308169,  -1638590967,
    -1869119, 314284737,   2994039,  -694382729,  22981,    1018755525,
    3548272,  1287922800,  -2635921, -45766801,   1228525,  -1787797779,
    -1250494, 72690498,    3767016,  1536588520,  671102,   -2135294594,
    -1595974, -6363718,    -2486353, 642772911,   2477047,  -1708872713,
    -1247620, 1354528380,  -4055324, 1637785316,  411027,   1262003603,
    -1265009, -1967222129, 2590150,  635454918,   3693493,  86965173,
    -2691481, 1176751719,  -2842341, 1920467227,  2967645,  -289871779,
    -203044,  -1629985060, -1735879, -137583815,  -2715295, -1518161567,
    3342277,  -1851023419, -3437287, 1223601433,  -2147896, 588790216,
    -4108315, -885133339,  2437823,  1123881663,  983419,   247357819,
    -286988,  -908452108,  -342297,  -2124962073, -3412210, 783134478,
    3595838,  -1258381762, 768622,   -128353682,  -126922,  2131021878,
    525098,   325927722,   3556995,  -1819892093, 3632928,  -568627424,
    -3207046, -1931587462, -2031748, 1372618620,  3157330,  -1529189038,
    3122442,  -1747917558, 655327,   -863641633,  3190144,  1440787840,
    522500,   -1926727420, 43260,    -2027935492, 1000202,  -1955560694,
    1613174,  818371958,   -495491,  -1014493059, 4083598,  993005454,
    -819034,  -1257750362, -909542,  517299994,   -1939314, 1039411342,
    -1859098, 421552614,   -900702,  -14253662,   1257611,  1285853323,
    3193378,  -1904936414, 1197226,  -1683520342, 1585221,  -140455867,
    3759364,  -1176904444, 3520352,  -2027833504, -2176455, -1599739335,
    -3513181, -2032221021, 1235728,  326425360,   -3475950, -1651689966,
    -2434439, 44694137,    -266997,  605900043,   1452451,  2143979939,
    3562462,  1420958686,  2446433,  -30313375,   3041255,  1974159335,
    -2244091, -912367099,  3342478,  1363460238,  3677745,  -1350681039,
    -3817976, -746144248,  -2316500, -1363007700, 1528703,  654783359,
    -3407706, -991903578,  -2091667, 898413,      3930395,  1574918427,
    2797779,  952438995,   -2071892, 1714807468,  2556880,  950076368,
    -3900724, 1495136972,  -280005,  1170414139,  -4010497, 1443016191,
    -2680103, -625853735,  -3881043, 1983539117,  -954230,  285388938,
    -531354,  1636082790,  -811944,  -1484874664, 19422,    -1837364258,
    -1757237, -329347125,  -3111497, 285697463,   -3699596, -2024403852,
    1600420,  -879957084,  2140649,  -992097815,  -3507263, 1925356481,
    3277672,  748618600,   1399561,  1257667337,  2884855,  -515185417,
    3821735,  -1831915353, -3505694, -418987550,  1643818,  901666090,
    1699267,  1750224323,  3859737,  878576921,   2118186,  -1654287830,
    -3119733, 1929495947,  539299,   1104976547,  -2348700, 1661512036,
    300467,   -2059733581, -3539968, 1061813248,  2108549,  -684667771,
    -2619752, 346752664,   2091905,  1091570561,  2867647,  -1797021249,
    -3574422, 561427818,   3043716,  475984260,   3861115,  202001019,
    1119584,  -222489248,  549488,   -1806278032, 359251,   1374673747,
    -3915439, 594436433,   2537516,  1898723372,  3592148,  1076973524,
    1661693,  -1594295555, -3585928, -858240904,  1079900,  1364982364,
    -2353451, 1815525077,  -3530437, -1838055109, -3077325, 1404529459,
    -95776,   1631226336,  -2706023, 1846138265,  -1024112, -2082316400,
    -2725464, -1727305304, -1826347, -308362795,  -466468,  -1640734244,
    876248,   -1612161320, 777960,   -1477910808, -237124,  -1640767044,
    518909,   1927777021,  2608894,  1929875198,  3975713,  151046689,
};

const int32_t zetas_8l_ref[N] = {
    0,        25847,    -2608894, -518909,  237124,   -777960,  -876248,
    466468,   1826347,  2353451,  -359251,  -2091905, 3119733,  -2884855,
    3111497,  2680103,  2725464,  1024112,  -1079900, 3585928,  -549488,
    -1119584, 2619752,  -2108549, -2118186, -3859737, -1399561, -3277672,
    1757237,  -19422,   4010497,  280005,   2706023,  95776,    3077325,
    3530437,  -1661693, -3592148, -2537516, 3915439,  -3861115, -3043716,
    3574422,  -2867647, 3539968,  -300467,  2348700,  -539299,  -1699267,
    -1643818, 3505694,  -3821735, 3507263,  -2140649, -1600420, 3699596,
    811944,   531354,   954230,   3881043,  3900724,  -2556880, 2071892,
    -2797779, -3930395, -1528703, -3677745, -3041255, -1452451, 3475950,
    2176455,  -1585221, -1257611, 1939314,  -4083598, -1000202, -3190144,
    -3157330, -3632928, 126922,   3412210,  -983419,  2147896,  2715295,
    -2967645, -3693493, -411027,  -2477047, -671102,  -1228525, -22981,
    -1308169, -381987,  1349076,  1852771,  -1430430, -3343383, 264944,
    508951,   3097992,  44288,    -1100098, 904516,   3958618,  -3724342,
    -8578,    1653064,  -3249728, 2389356,  -210977,  759969,   -1316856,
    189548,   -3553272, 3159746,  -1851402, -2409325, -177440,  1315589,
    1341330,  1285669,  -1584928, -812732,  -1439742, -3019102, -3881060,
    -3628969, 3839961,  2091667,  3407706,  2316500,  3817976,  -3342478,
    2244091,  -2446433, -3562462, 266997,   2434439,  -1235728, 3513181,
    -3520352, -3759364, -1197226, -3193378, 900702,   1859098,  909542,
    819034,   495491,   -1613174, -43260,   -522500,  -655327,  -3122442,
    2031748,  3207046,  -3556995, -525098,  -768622,  -3595838, 342297,
    286988,   -2437823, 4108315,  3437287,  -3342277, 1735879,  203044,
    2842341,  2691481,  -2590150, 1265009,  4055324,  1247620,  2486353,
    1595974,  -3767016, 1250494,  2635921,  -3548272, -2994039, 1869119,
    1903435,  -1050970, -1333058, 1237275,  -3318210, -1430225, -451100,
    1312455,  3306115,  -1962642, -1279661, 1917081,  -2546312, -1374803,
    1500165,  777191,   2235880,  3406031,  -542412,  -2831860, -1671176,
    -1846953, -2584293, -3724270, 594136,   -3776993, -2013608, 2432395,
    2454455,  -164721,  1957272,  3369112,  185531,   -1207385, -3183426,
    162844,   1616392,  3014001,  810149,   1652634,  -3694233, -1799107,
    -3038916, 3523897,  3866901,  269760,   2213111,  -975884,  1717735,
    472078,   -426683,  1723600,  -1803090, 1910376,  -1667432, -1104333,
    -260646,  -3833893, -2939036, -2235985, -420899,  -2286327, 183443,
    -976891,  1612842,  -3545687, -554416,  3919660,  -48306,   -1362209,
    3937738,  1400424,  -846154,  1976782};

int32_t montgomery_reduce(int64_t a)
{
    int32_t t;

    t = (int64_t)(int32_t)a * QINV;
    t = (a - (int64_t)t * Q) >> 32;
    return t;
}

void ntt(int32_t a[N])
{
    unsigned int len, start, j, k;
    int32_t zeta, t;

    k = 0;
    // len >= 4
    for (len = 128; len >= 4; len >>= 1) {
        for (start = 0; start < N; start = j + len) {
            zeta = zetas_ntt[k++];
            for (j = start; j < start + len; ++j) {
                t = montgomery_reduce((int64_t)zeta * a[j + len]);
                a[j + len] = a[j] - t;
                a[j] = a[j] + t;
            }
        }
    }
}

void intt(int32_t a[N])
{
    unsigned int start, len, j, k;
    int32_t t, zeta;
    const int32_t f = 167912;  // mont^2/64

    k = 0;
    for (len = 4; len <= 128; len <<= 1) {
        for (start = 0; start < N; start = j + len) {
            zeta = zetas_intt[k++];
            for (j = start; j < start + len; ++j) {
                t = a[j];
                a[j] = t + a[j + len];
                a[j + len] = t - a[j + len];
                a[j + len] = montgomery_reduce((int64_t)zeta * a[j + len]);
            }
        }
    }
    for (j = 0; j < N; ++j) {
        a[j] = montgomery_reduce((int64_t)f * a[j]);
    }
}

void basemul(int32_t r[N], int32_t a[N], int32_t b[N])
{
    int64_t t;
    int32_t a0, a1, a2, a3, i;
    int32_t b0, b1, b2, b3;
    int32_t zeta;
    for (i = 0; i < N / 4; i++) {
        zeta = zetas_basemul[i >> 1];
        if (i & 1 == 1)
            zeta = -zeta;
        // get values from memory for storing result
        a0 = a[4 * i + 0];
        a1 = a[4 * i + 1];
        a2 = a[4 * i + 2];
        a3 = a[4 * i + 3];
        b0 = b[4 * i + 0];
        b1 = b[4 * i + 1];
        b2 = b[4 * i + 2];
        b3 = b[4 * i + 3];
        // r0=a0b0+zeta*(a1b3+a2b2+a3b1)
        t = (int64_t)a1 * b3;
        t += (int64_t)a2 * b2;
        t += (int64_t)a3 * b1;
        r[4 * i + 0] = montgomery_reduce(t);
        r[4 * i + 0] = montgomery_reduce((int64_t)r[4 * i + 0] * zeta);
        r[4 * i + 0] += montgomery_reduce((int64_t)a0 * b0);
        // r1=a0b1+a1b0+zeta*(a2b3+a3b2)
        t = (int64_t)a2 * b3;
        t += (int64_t)a3 * b2;
        r[4 * i + 1] = montgomery_reduce(t);
        r[4 * i + 1] = montgomery_reduce((int64_t)r[4 * i + 1] * zeta);
        t = (int64_t)a0 * b1;
        t += (int64_t)a1 * b0;
        r[4 * i + 1] += montgomery_reduce(t);
        // r2=a0b2+a1b1+a2b0+zeta*(a3b3)
        r[4 * i + 2] = montgomery_reduce((int64_t)a3 * b3);
        r[4 * i + 2] = montgomery_reduce((int64_t)r[4 * i + 2] * zeta);
        t = (int64_t)a0 * b2;
        t += (int64_t)a1 * b1;
        t += (int64_t)a2 * b0;
        r[4 * i + 2] += montgomery_reduce(t);
        // r3=a0b3+a1b2+a2b1+a3b0
        t = (int64_t)a0 * b3;
        t += (int64_t)a1 * b2;
        t += (int64_t)a2 * b1;
        t += (int64_t)a3 * b0;
        r[4 * i + 3] = montgomery_reduce(t);
    }
}

void ntt_8l_ref(int32_t a[N])
{
    unsigned int len, start, j, k;
    int32_t zeta, t;

    k = 0;
    for (len = 128; len > 0; len >>= 1) {
        for (start = 0; start < N; start = j + len) {
            zeta = zetas_8l_ref[++k];
            for (j = start; j < start + len; ++j) {
                t = montgomery_reduce((int64_t)zeta * a[j + len]);
                a[j + len] = a[j] - t;
                a[j] = a[j] + t;
            }
        }
    }
}

void intt_8l_ref(int32_t a[N])
{
    unsigned int start, len, j, k;
    int32_t t, zeta;
    const int32_t f = 41978;  // mont^2/256

    k = 256;
    for (len = 1; len <= 128; len <<= 1) {
        for (start = 0; start < N; start = j + len) {
            zeta = -zetas_8l_ref[--k];
            for (j = start; j < start + len; ++j) {
                t = a[j];
                a[j] = t + a[j + len];
                a[j + len] = t - a[j + len];
                a[j + len] = montgomery_reduce((int64_t)zeta * a[j + len]);
            }
        }
    }

    for (j = 0; j < N; ++j) {
        a[j] = montgomery_reduce((int64_t)f * a[j]);
    }
}

void basemul_8l_ref(int32_t c[N], int32_t a[N], int32_t b[N])
{
    int i;
    for (i = 0; i < N; i++)
        c[i] = montgomery_reduce((int64_t)a[i] * b[i]);
}

void print_poly(int32_t *a, size_t n)
{
    int i;
    for (i = 0; i < n; i++) {
        if (i != 0 && i % 16 == 0)
            printf("\n");
        printf("%d, ", a[i]);
    }
    printf("\n\n");
}

int poly_equal(int32_t *a, int32_t *b, size_t n)
{
    size_t i;
    int ok = 1;
    for (i = 0; i < n; i++) {
        if (((a[i] + Q * 10) % Q) != ((b[i] + Q * 10) % Q)) {
            ok = 0;
            break;
        }
    }
    return ok;
}

void poly_naivemul(int32_t *c, int32_t *a, int32_t *b)
{
    unsigned int i, j;
    int32_t r[2 * N] = {0};

    for (i = 0; i < N; i++)
        for (j = 0; j < N; j++)
            r[i + j] = (r[i + j] + (int64_t)a[i] * b[j]) % Q;

    for (i = N; i < 2 * N; i++)
        r[i - N] = (r[i - N] - r[i]) % Q;

    for (i = 0; i < N; i++)
        c[i] = r[i];
}

// extern void ntt_6l_rv32im(int32_t *r, int32_t *zetas);
// extern void intt_6l_rv32im(int32_t *r, int32_t *zetas);
// extern void poly_barrett_rdc_rv32im(int32_t *r);
// extern void poly_tomont_rv32im(int32_t *r);

// extern void poly_basemul_acc_rv32im(int64_t *r, const int32_t *a,
//                                     const int32_t *b, int32_t *zetas);
// extern void poly_basemul_acc_end_rv32im(int32_t *r, const int32_t *a,
//                                         const int32_t *b, int32_t
//                                         *zetas, int64_t *r_double);
// extern void poly_basemul_cache_init_rv32im(int64_t *r, const int32_t *a,
//                                            const int32_t *b,
//                                            int32_t *b_cache,
//                                            int32_t *zetas);
// extern void poly_basemul_acc_cached_rv32im(int64_t *r, const int32_t *a,
//                                            const int32_t *b,
//                                            int32_t *b_cache);
// extern void poly_basemul_acc_cache_init_end_rv32im(
//     int32_t *r, const int32_t *a, const int32_t *b, int32_t *b_cache,
//     int32_t *zetas, int64_t *r_double);
// extern void poly_basemul_acc_cache_end_rv32im(int32_t *r, const int32_t
// *a,
//                                               const int32_t *b,
//                                               int32_t *b_cache,
//                                               int64_t *r_double);

extern void poly_basemul_6l_rv32im(int32_t *r, const int32_t *a,
                                   const int32_t *b, int32_t *zetas);

#define NTESTS 1000
uint64_t t[NTESTS];

int main()
{
    int32_t a[N], b[N], b_cache[192], c0[N], c1[N], i, j;
    int64_t c_double[N];

    for (i = 0; i < N; i++)
        a[i] = 2;
    for (i = 0; i < N; i++)
        b[i] = 1;
    ntt(a);
    ntt(b);
    basemul(c0, a, b);
    intt(c0);

    // for (i = 0; i < N; i++)
    //     a[i] = 2;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // poly_naivemul(c, a, b);
    // print_poly(c, N);

    // memset(c1, 0, N * sizeof(int32_t));
    // memset(c_double, 0, N * sizeof(int64_t));
    // for (i = 0; i < N; i++)
    //     a[i] = 2;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // ntt_6l_rv32im(a, zetas_33merging_ntt);
    // ntt_6l_rv32im(b, zetas_33merging_ntt);
    // poly_basemul_6l_rv32im(c1, a, b, zetas_33merging_basemul);
    // intt_6l_rv32im(c1, zetas_33merging_intt);
    // if (poly_equal(c0, c1, N) == 0) {
    //     print_poly(c0, N);
    //     print_poly(c1, N);
    // }

    // memset(c1, 0, N * sizeof(int32_t));
    // memset(c_double, 0, N * sizeof(int64_t));
    // for (i = 0; i < N; i++)
    //     a[i] = 1;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // ntt_6l_rv32im(a, zetas_33merging_ntt);
    // ntt_6l_rv32im(b, zetas_33merging_ntt);
    // poly_basemul_6l_acc_rv32im(c_double, a, b, zetas_33merging_basemul);
    // poly_basemul_6l_acc_end_rv32im(c1, a, b, zetas_33merging_basemul,
    //                                c_double);
    // intt_6l_rv32im(c1, zetas_33merging_intt);
    // if (poly_equal(c0, c1, N) == 0) {
    //     print_poly(c0, N);
    //     print_poly(c1, N);
    // }

    // for (i = 0; i < N; i++)
    //     a[i] = 1;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // ntt(a);
    // ntt(b);
    // basemul(c0, a, b);
    // intt(c0);

    // memset(c1, 0, N * sizeof(int32_t));
    // memset(c_double, 0, N * sizeof(int64_t));
    // memset(b_cache, 0, 192 * sizeof(int32_t));
    // for (i = 0; i < N; i++)
    //     a[i] = 1;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // ntt_6l_rv32im(a, zetas_33merging_ntt);
    // ntt_6l_rv32im(b, zetas_33merging_ntt);
    // poly_basemul_6l_cache_init_rv32im(c_double, a, b, b_cache,
    //                                   zetas_33merging_basemul);
    // poly_basemul_6l_cached_rv32im(c1, a, b, b_cache);
    // intt_6l_rv32im(c1, zetas_33merging_intt);
    // if (poly_equal(c0, c1, N) == 0) {
    //     print_poly(c0, N);
    //     print_poly(c1, N);
    // }

    // for (i = 0; i < N; i++)
    //     a[i] = 3;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // ntt(a);
    // ntt(b);
    // basemul(c0, a, b);
    // intt(c0);

    // memset(c1, 0, N * sizeof(int32_t));
    // memset(c_double, 0, N * sizeof(int64_t));
    // memset(b_cache, 0, 192 * sizeof(int32_t));
    // for (i = 0; i < N; i++)
    //     a[i] = 1;
    // for (i = 0; i < N; i++)
    //     b[i] = 1;
    // ntt_6l_rv32im(a, zetas_33merging_ntt);
    // ntt_6l_rv32im(b, zetas_33merging_ntt);
    // poly_basemul_6l_cache_init_rv32im(c_double, a, b, b_cache,
    //                                   zetas_33merging_basemul);
    // poly_basemul_6l_acc_cache_init_rv32im(c_double, a, b, b_cache,
    //                                       zetas_33merging_basemul);
    // poly_basemul_6l_acc_cache_end_rv32im(c1, a, b, b_cache, c_double);
    // intt_6l_rv32im(c1, zetas_33merging_intt);
    // if (poly_equal(c0, c1, N) == 0) {
    //     print_poly(c0, N);
    //     print_poly(c1, N);
    // }

    // memset(c1, 0, N * sizeof(int32_t));
    // memset(c_double, 0, N * sizeof(int64_t));
    // poly_basemul_6l_cache_init_rv32im(c_double, a, b, b_cache,
    //                                   zetas_33merging_basemul);
    // poly_basemul_6l_acc_cached_rv32im(c_double, a, b, b_cache);
    // poly_basemul_6l_acc_cache_init_end_rv32im(
    //     c1, a, b, b_cache, zetas_33merging_basemul, c_double);
    // intt_6l_rv32im(c1, zetas_33merging_intt);
    // if (poly_equal(c0, c1, N) == 0) {
    //     print_poly(c0, N);
    //     print_poly(c1, N);
    // }

    // memset(c1, 0, N * sizeof(int32_t));
    // memset(c_double, 0, N * sizeof(int64_t));
    // poly_basemul_6l_acc_cached_rv32im(c_double, a, b, b_cache);
    // poly_basemul_6l_acc_cached_rv32im(c_double, a, b, b_cache);
    // poly_basemul_6l_acc_cache_end_rv32im(c1, a, b, b_cache, c_double);
    // intt_6l_rv32im(c1, zetas_33merging_intt);
    // if (poly_equal(c0, c1, N) == 0) {
    //     print_poly(c0, N);
    //     print_poly(c1, N);
    // }

    for (i = 0; i < N; i++)
        a[i] = 3;
    for (i = 0; i < N; i++)
        b[i] = 1;
    ntt_8l_ref(a);
    ntt_8l_ref(b);
    basemul_8l_ref(c0, a, b);
    intt_8l_ref(c0);
    // print_poly(c0, N);

    memset(c1, 0, N * sizeof(int32_t));
    memset(c_double, 0, N * sizeof(int64_t));
    for (i = 0; i < N; i++)
        a[i] = 1;
    for (i = 0; i < N; i++)
        b[i] = 1;
    ntt_8l_rv32im(a, zetas_ntt_8l_rv32im);
    ntt_8l_rv32im(b, zetas_ntt_8l_rv32im);
    poly_basemul_8l_init_rv32im(c_double, a, b);
    poly_basemul_8l_acc_rv32im(c_double, a, b);
    poly_basemul_8l_acc_end_rv32im(c1, a, b, c_double);
    intt_8l_rv32im(c1, zetas_intt_8l_rv32im);
    // print_poly(c1, N);
    if (poly_equal(c0, c1, N) == 0) {
        printf("8l ntt error\n");
        print_poly(c0, N);
        print_poly(c1, N);
    }

#if 1

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        ntt_8l_rv32im(a, zetas_ntt_8l_rv32im);
    }
    print_results("ntt_8l_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_8l_init_rv32im(c_double, a, b);
    }
    print_results("poly_basemul_8l_init_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_8l_acc_rv32im(c_double, a, b);
    }
    print_results("poly_basemul_8l_acc_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_8l_acc_end_rv32im(c1, a, b, c_double);
    }
    print_results("poly_basemul_8l_acc_end_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_8l_rv32im(c1, a, b);
    }
    print_results("poly_basemul_8l_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        intt_8l_rv32im(c1, zetas_intt_8l_rv32im);
    }
    print_results("intt_8l_rv32im:", t, NTESTS);

#endif

#if 0

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        ntt_6l_rv32im(a, zetas_33merging_ntt);
    }
    print_results("ntt_6l_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_rv32im(c0, a, b, zetas_33merging_basemul);
    }
    print_results("poly_basemul_6l_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_acc_rv32im(c_double, a, b,
                                   zetas_33merging_basemul);
    }
    print_results("poly_basemul_6l_acc_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_acc_end_rv32im(c0, a, b, zetas_33merging_basemul,
                                       c_double);
    }
    print_results("poly_basemul_6l_acc_end_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_cache_init_rv32im(c_double, a, b, b_cache,
                                          zetas_33merging_basemul);
    }
    print_results("poly_basemul_6l_cache_init_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_acc_cache_init_rv32im(c_double, a, b, b_cache,
                                              zetas_33merging_basemul);
    }
    print_results("poly_basemul_6l_acc_cache_init_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_acc_cached_rv32im(c_double, a, b, b_cache);
    }
    print_results("poly_basemul_6l_acc_cached_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_acc_cache_init_end_rv32im(
            c1, a, b, b_cache, zetas_33merging_basemul, c_double);
    }
    print_results("poly_basemul_6l_acc_cache_init_end_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_cached_rv32im(c1, a, b, b_cache);
    }
    print_results("poly_basemul_6l_cached_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        poly_basemul_6l_acc_cache_end_rv32im(c1, a, b, b_cache, c_double);
    }
    print_results("poly_basemul_6l_acc_cache_end_rv32im:", t, NTESTS);

    for (i = 0; i < NTESTS; ++i) {
        t[i] = cpucycles();
        intt_6l_rv32im(c0, zetas_33merging_intt);
    }
    print_results("intt_6l_rv32im:", t, NTESTS);

#endif

    return 0;
}